{"version":3,"file":"parser.js","names":["_compat","require","parser","tokens","options","root","tagName","children","state","cursor","stack","parse","hasTerminalParent","terminals","tagParents","currentIndex","length","parentTagName","arrayIncludes","rewindStack","newLength","childrenEndPosition","endPosition","position","end","i","len","splice","nodes","token","type","push","tagToken","content","toLowerCase","close","index","shouldRewind","endToken","start","isClosingTag","closingTags","shouldRewindToAutoClose","closingTagAncestorBreakers","previousIndex","attributes","attrToken","elementNode","hasChildren","voidTags","size","innerState","rewoundInElement"],"sources":["parser.js"],"sourcesContent":["import { arrayIncludes } from './compat'\n\nexport default function parser(tokens, options) {\n  const root = { tagName: null, children: [] }\n  const state = { tokens, options, cursor: 0, stack: [root] }\n  parse(state)\n  return root.children\n}\n\nexport function hasTerminalParent(tagName, stack, terminals) {\n  const tagParents = terminals[tagName]\n  if (tagParents) {\n    let currentIndex = stack.length - 1\n    while (currentIndex >= 0) {\n      const parentTagName = stack[currentIndex].tagName\n      if (parentTagName === tagName) {\n        break\n      }\n      if (arrayIncludes(tagParents, parentTagName)) {\n        return true\n      }\n      currentIndex--\n    }\n  }\n  return false\n}\n\nexport function rewindStack(\n  stack,\n  newLength,\n  childrenEndPosition,\n  endPosition,\n) {\n  stack[newLength].position.end = endPosition\n  for (let i = newLength + 1, len = stack.length; i < len; i++) {\n    stack[i].position.end = childrenEndPosition\n  }\n  stack.splice(newLength)\n}\n\nexport function parse(state) {\n  const { tokens, options } = state\n  let { stack } = state\n  let nodes = stack[stack.length - 1].children\n  const len = tokens.length\n  let { cursor } = state\n  while (cursor < len) {\n    const token = tokens[cursor]\n    if (token.type !== 'tag-start') {\n      nodes.push(token)\n      cursor++\n      continue\n    }\n\n    const tagToken = tokens[++cursor]\n    cursor++\n    const tagName = tagToken.content.toLowerCase()\n    if (token.close) {\n      let index = stack.length\n      let shouldRewind = false\n      while (--index > -1) {\n        if (stack[index].tagName === tagName) {\n          shouldRewind = true\n          break\n        }\n      }\n      while (cursor < len) {\n        const endToken = tokens[cursor]\n        if (endToken.type !== 'tag-end') break\n        cursor++\n      }\n      if (shouldRewind) {\n        rewindStack(\n          stack,\n          index,\n          token.position.start,\n          tokens[cursor - 1].position.end,\n        )\n        break\n      } else {\n        continue\n      }\n    }\n\n    const isClosingTag = arrayIncludes(options.closingTags, tagName)\n    let shouldRewindToAutoClose = isClosingTag\n    if (shouldRewindToAutoClose) {\n      const { closingTagAncestorBreakers: terminals } = options\n      shouldRewindToAutoClose = !hasTerminalParent(tagName, stack, terminals)\n    }\n\n    if (shouldRewindToAutoClose) {\n      // rewind the stack to just above the previous\n      // closing tag of the same name\n      let currentIndex = stack.length - 1\n      while (currentIndex > 0) {\n        if (tagName === stack[currentIndex].tagName) {\n          rewindStack(\n            stack,\n            currentIndex,\n            token.position.start,\n            token.position.start,\n          )\n          const previousIndex = currentIndex - 1\n          nodes = stack[previousIndex].children\n          break\n        }\n        currentIndex = currentIndex - 1\n      }\n    }\n\n    let attributes = []\n    let attrToken\n    while (cursor < len) {\n      attrToken = tokens[cursor]\n      if (attrToken.type === 'tag-end') break\n      attributes.push(attrToken.content)\n      cursor++\n    }\n\n    cursor++\n    const children = []\n    const position = {\n      start: token.position.start,\n      end: attrToken.position.end,\n    }\n    const elementNode = {\n      type: 'element',\n      tagName: tagToken.content,\n      attributes,\n      children,\n      position,\n    }\n    nodes.push(elementNode)\n\n    const hasChildren = !(\n      attrToken.close || arrayIncludes(options.voidTags, tagName)\n    )\n    if (hasChildren) {\n      const size = stack.push({ tagName, children, position })\n      const innerState = { tokens, options, cursor, stack }\n      parse(innerState)\n      cursor = innerState.cursor\n      const rewoundInElement = stack.length === size\n      if (rewoundInElement) {\n        elementNode.position.end = tokens[cursor - 1].position.end\n      }\n    }\n  }\n  state.cursor = cursor\n}\n"],"mappings":"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"}